<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>üÉè Durak Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  background: radial-gradient(circle at top, #146b3a, #0b3d22);
  color: #fff;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

header {
  padding: 10px;
  text-align: center;
  font-weight: 600;
}

#status {
  font-size: 14px;
  opacity: .85;
}

#trump {
  font-size: 16px;
  margin-top: 4px;
}

#table {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
}

#hand {
  padding: 12px;
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
}

.card {
  width: 64px;
  height: 96px;
  background: #fff;
  color: #000;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: transform .15s, box-shadow .15s;
}

.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 8px 16px rgba(0,0,0,.25);
}

.card.disabled {
  opacity: .4;
  cursor: default;
  transform: none;
  box-shadow: none;
}

.controls {
  display: flex;
  justify-content: center;
  gap: 12px;
  padding-bottom: 10px;
}

button {
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}

#bito { background: #ffd700; }
#take { background: #ff6b6b; }

.hidden { display: none; }
</style>
</head>

<body>

<header>
  <div>üÉè Durak Online</div>
  <div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶</div>
  <div id="trump"></div>
</header>

<div id="table"></div>

<div class="controls">
  <button id="bito" class="hidden">–ë–∏—Ç–æ</button>
  <button id="take" class="hidden">–ó–∞–±—Ä–∞—Ç—å</button>
</div>

<div id="hand"></div>

<script>
(() => {
  const WSS_URL = "wss://durak-server-pfxg.onrender.com";

  const tg = window.Telegram?.WebApp;
  if (!tg) return setStatus("–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram");

  tg.ready();
  const user = tg.initDataUnsafe?.user;
  if (!user) return setStatus("–ù–µ—Ç Telegram user");

  let ws;
  let hand = [];
  let table = {};
  let phase = "";
  let yourTurn = false;

  const statusEl = document.getElementById("status");
  const trumpEl = document.getElementById("trump");
  const handEl = document.getElementById("hand");
  const tableEl = document.getElementById("table");
  const bitoBtn = document.getElementById("bito");
  const takeBtn = document.getElementById("take");

  function setStatus(text) {
    statusEl.innerText = text;
  }

  function connect() {
    ws = new WebSocket(WSS_URL);

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: "join", playerId: user.id }));
      setStatus("–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞‚Ä¶");
    };

    ws.onmessage = e => {
      const d = JSON.parse(e.data);

      if (d.type === "state") {
        hand = d.hand || [];
        table = d.table || {};
        phase = d.phase || "";
        yourTurn = !!d.yourTurn;
        trumpEl.innerText = "–ö–æ–∑—ã—Ä—å: " + d.trump;
        render();
      }

      if (d.type === "update") {
        table = d.table || table;
        render();
      }
    };

    ws.onerror = () => setStatus("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
    ws.onclose = () => setTimeout(connect, 1500);
  }

  function render() {
    setStatus(
      phase === "attack"
        ? (yourTurn ? "–¢–≤–æ–π —Ö–æ–¥" : "–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞")
        : phase === "defense"
        ? (yourTurn ? "–ó–∞—â–∏—â–∞–π—Å—è" : "–°–æ–ø–µ—Ä–Ω–∏–∫ –∑–∞—â–∏—â–∞–µ—Ç—Å—è")
        : "–û–∂–∏–¥–∞–Ω–∏–µ‚Ä¶"
    );

    tableEl.innerHTML = "";
    if (table.attack) tableEl.appendChild(cardEl(table.attack));
    if (table.defense) tableEl.appendChild(cardEl(table.defense));

    handEl.innerHTML = "";
    hand.forEach(card => {
      const el = cardEl(card);
      if (!yourTurn) el.classList.add("disabled");
      el.onclick = () => {
        if (!yourTurn) return;
        ws.send(JSON.stringify({
          type: phase === "attack" ? "attack" : "defend",
          card
        }));
      };
      handEl.appendChild(el);
    });

    bitoBtn.classList.toggle("hidden", !(phase === "defense" && !yourTurn));
    takeBtn.classList.toggle("hidden", !(phase === "defense" && yourTurn));
  }

  function cardEl(card) {
    const el = document.createElement("div");
    el.className = "card";
    el.innerText = card.rank + card.suit;
    return el;
  }

  bitoBtn.onclick = () => ws.send(JSON.stringify({ type: "bito" }));
  takeBtn.onclick = () => ws.send(JSON.stringify({ type: "take" }));

  connect();
})();
</script>

</body>
</html>
