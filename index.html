<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üÉè –î—É—Ä–∞–∫ –û–Ω–ª–∞–π–Ω</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram Mini App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      background: #0b5c2d;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }

    h1 {
      margin-top: 10px;
    }

    #status {
      margin: 10px 0;
      font-weight: bold;
    }

    #table {
      min-height: 100px;
      margin: 10px 0;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    #hand {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .card {
      width: 60px;
      height: 90px;
      background: white;
      color: black;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
    }

    .card.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<h1>üÉè –î—É—Ä–∞–∫ –û–Ω–ª–∞–π–Ω</h1>
<div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É‚Ä¶</div>
<div id="table"></div>
<div id="hand"></div>

<script>
/* ===== –ü–£–ë–õ–ò–ß–ù–´–ô WEBSOCKET –° RENDER ===== */
const WSS_URL = "wss://durak-server-pfxg.onrender.com";

/* ===== Telegram ===== */
const tg = window.Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe?.user;
if (!user) {
  document.getElementById("status").innerText =
    "–û—Ç–∫—Ä–æ–π –∏–≥—Ä—É —á–µ—Ä–µ–∑ Telegram";
  throw new Error("No Telegram user");
}

const playerId = user.id;

/* ===== WebSocket ===== */
const ws = new WebSocket(WSS_URL);

let hand = [];

/* ===== WebSocket events ===== */
ws.onopen = () => {
  ws.send(JSON.stringify({
    type: "join",
    playerId: playerId
  }));
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if (data.type === "start") {
    hand = data.hand;
    document.getElementById("status").innerText =
      data.turn ? "–¢–≤–æ–π —Ö–æ–¥" : "–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞";
    renderHand();
  }

  if (data.type === "update") {
    renderTable(data.table);
  }
};

ws.onerror = () => {
  document.getElementById("status").innerText =
    "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É";
};

/* ===== Render functions ===== */
function renderHand() {
  const handDiv = document.getElementById("hand");
  handDiv.innerHTML = "";

  hand.forEach((card, index) => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerText = card.rank + card.suit;

    el.addEventListener("click", () => {
      ws.send(JSON.stringify({
        type: "play",
        card: card
      }));
      hand.splice(index, 1);
      renderHand();
    });

    handDiv.appendChild(el);
  });
}

function renderTable(table) {
  const tableDiv = document.getElementById("table");
  tableDiv.innerHTML = "";

  table.forEach(card => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerText = card.rank + card.suit;
    tableDiv.appendChild(el);
  });
}
</script>

</body>
</html>
